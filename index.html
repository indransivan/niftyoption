<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NIFTY MACD Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.0.0/dist/chartjs-chart-financial.min.js"></script>
<style>
body { font-family: sans-serif; background:#0a0a0a; color:white; padding:15px }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:15px }
.card { padding:20px; border-radius:12px; text-align:center; }
.buy { background:#00ff8840; border:2px solid #00ff88; }
.sell { background:#ff444440; border:2px solid #ff4444; }
</style>
</head>
<body>
<h1>ðŸš€ NIFTY Options MACD Dashboard</h1>
<div class="grid" id="signals"></div>
<div>Last update: <span id="timestamp"></span></div>

<canvas id="callChart" height="300"></canvas>
<canvas id="putChart" height="300"></canvas>

<script>
const { Chart, registerables } = Chart;
Chart.register(...registerables);

let callChart, putChart;

const ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws"
);

ws.onmessage = (event) => {
    const d = JSON.parse(event.data);

    if(d.error){
        document.getElementById("signals").innerHTML = "<b>Error: "+d.error+"</b>";
        return;
    }

    document.getElementById("signals").innerHTML = `
        <div class="card ${d.call_signal.toLowerCase()}">
            <h2>ðŸ“ˆ CALL ${d.call_strike}</h2>
            <h1>${d.call_signal}</h1>
            <div>MACD: ${d.call_macd}</div>
        </div>
        <div class="card ${d.put_signal.toLowerCase()}">
            <h2>ðŸ“‰ PUT ${d.put_strike}</h2>
            <h1>${d.put_signal}</h1>
            <div>MACD: ${d.put_macd}</div>
        </div>
    `;
    document.getElementById("timestamp").innerText = d.timestamp;

    const formatCandles = (candles) => candles
        .filter(c => c.o && c.h && c.l && c.c)
        .map(c => ({
            x: new Date(c.time), // convert to Date object
            o: parseFloat(c.open),
            h: parseFloat(c.high),
            l: parseFloat(c.low),
            c: parseFloat(c.close)
        }));

    const callData = formatCandles(d.call_candles);
    const putData = formatCandles(d.put_candles);

    // Create or update call chart
    if(!callChart){
        callChart = new Chart(document.getElementById('callChart'), {
            type: 'candlestick',
            data: { datasets: [{ label:'CALL', data: callData }] },
            options: {
                plugins:{legend:{display:false}},
                responsive:true,
                scales:{
                    x:{ type:'time', time:{ unit:'hour' } },
                    y:{ position:'right' }
                }
            }
        });
    } else {
        callChart.data.datasets[0].data = callData;
        callChart.update();
    }

    // Create or update put chart
    if(!putChart){
        putChart = new Chart(document.getElementById('putChart'), {
            type: 'candlestick',
            data: { datasets: [{ label:'PUT', data: putData }] },
            options: {
                plugins:{legend:{display:false}},
                responsive:true,
                scales:{
                    x:{ type:'time', time:{ unit:'hour' } },
                    y:{ position:'right' }
                }
            }
        });
    } else {
        putChart.data.datasets[0].data = putData;
        putChart.update();
    }
};
</script>
</body>
</html>
